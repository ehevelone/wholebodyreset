<!DOCTYPE html>
<html lang="en">
<head>
  <base href="/" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>Your Guided Plan | Whole Body Reset</title>

  <link rel="stylesheet" href="css/site.css">
  <meta name="robots" content="noindex, nofollow">

  <style>
    body {
      margin: 0;
      font-family: Georgia, "Times New Roman", serif;
      background: #efe4c9;
      color: #2f3b2f;
      line-height: 1.6;
    }

    header {
      background: #e2d6b8;
      padding: 20px 40px;
      display: flex;
      align-items: center;
    }

    header img {
      height: 48px;
      width: auto;
      display: block;
    }

    main {
      max-width: 900px;
      margin: 60px auto;
      padding: 0 20px;
    }

    .callout {
      background: #d6cfb2;
      padding: 24px;
      border-radius: 12px;
    }

    h1 { margin-top: 0; }
    h2 { margin-top: 28px; }
    h3 { margin-top: 18px; }
    ul { padding-left: 22px; }

    .box {
      background: #efe4c9;
      border: 1px solid #b9b29a;
      border-radius: 10px;
      padding: 16px;
      margin: 14px 0;
    }

    .muted {
      color: #4f5a45;
      font-size: 0.95rem;
    }

    textarea {
      width: 100%;
      min-height: 120px;
      padding: 10px;
      font-family: inherit;
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #b9b29a;
      background: #fff;
      margin-top: 10px;
    }

    button {
      margin-top: 16px;
      background: #2f3b2f;
      color: #fff;
      border: none;
      padding: 12px 22px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
    }

    button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .disclaimer {
      margin-top: 26px;
      font-size: 0.9rem;
      color: #4f5a45;
      border-top: 1px solid #b9b29a;
      padding-top: 16px;
    }

    footer {
      margin-top: 80px;
      padding: 40px 20px;
      background: #e2d6b8;
      font-size: 0.9rem;
      color: #4f5a45;
      text-align: center;
    }
  </style>
</head>

<body>

<div class="leafy-left"></div>
<div class="leafy-right"></div>

<header>
  <img src="images/et-naturals-logo.png" alt="ET Naturals Logo">
</header>

<main>
  <h1>Your Guided Plan</h1>
  <div id="output" class="callout">Loadingâ€¦</div>
</main>

<footer>
  <p>Â© ET Naturals. All rights reserved.</p>
  <p>Educational content only. No medical claims.</p>
</footer>

<script>
(function () {
  const out = document.getElementById("output");
  const raw = localStorage.getItem("ai_result") || sessionStorage.getItem("ai_result");

  if (!raw) {
    out.innerHTML = "<p>No plan data was received. Please restart the intake.</p>";
    return;
  }

  let data = null;
  try { data = JSON.parse(raw); } catch {}

  if (!data) {
    out.innerHTML = "<p>Unable to load your plan. Please restart the intake.</p>";
    return;
  }

  if (!data.state && data.plan) {
    data.state = "success";
  }

  if (data.state === "error") {
    out.innerHTML = `
      <h2>Something went wrong</h2>
      <p>${data.message || "Please try again."}</p>
    `;
    return;
  }

  if (data.state !== "success" || !data.plan) {
    out.innerHTML = "<p>Unable to load your plan. Please restart the intake.</p>";
    return;
  }

  const p = data.plan;

  const phaseBox = (title, obj) => {
    const goal = obj?.goal ? `<p><strong>Goal:</strong> ${obj.goal}</p>` : "";
    const actions = Array.isArray(obj?.actions) && obj.actions.length
      ? `<ul>${obj.actions.map(a => `<li>${a}</li>`).join("")}</ul>`
      : "<p class='muted'>â€”</p>";
    return `<div class="box"><h3>${title}</h3>${goal}${actions}</div>`;
  };

  out.innerHTML = `
    <h2>Focus Today</h2>
    <p>${p.focus_today || ""}</p>

    <h2>Whatâ€™s Going On</h2>
    <p>${p.plan_overview || ""}</p>

    <div class="box">
      <p><strong>Dominant driver:</strong> ${p.dominant_driver || ""}</p>
      <p><strong>Medication context:</strong> ${p.medication_context || ""}</p>
    </div>

    <h2>Day-by-Day Plan</h2>
    ${phaseBox("Day 1â€“2", p.day_1_2)}
    ${phaseBox("Day 3â€“4", p.day_3_4)}
    ${phaseBox("After Day 4", p.after_day_4)}

    <!-- ðŸ”¹ CONTEXT REFINEMENT (NEW) -->
    <div class="box">
      <h3>Have you already explored this path?</h3>
      <p class="muted">
        If youâ€™ve already had testing, evaluations, or tried something that changed how this feels,
        you can share that here so the system can adjust its reasoning.
      </p>

      <textarea id="refinementInput"
        placeholder="Example: Upper and lower GI were completed and nothing was found. Symptoms improved previously with gentle gut support."></textarea>

      <button id="refineBtn">Update plan with this context</button>
    </div>

    <div class="disclaimer">${data.disclaimer || ""}</div>
  `;

  // Placeholder hook â€” backend wiring comes next
  document.getElementById("refineBtn").addEventListener("click", () => {
    const txt = document.getElementById("refinementInput").value.trim();
    if (!txt) return;

    localStorage.setItem("ai_refinement", txt);
    alert("Context saved. Weâ€™ll use this to adjust the plan next.");
  });
})();
</script>

</body>
</html>
